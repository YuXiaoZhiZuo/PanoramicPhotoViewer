<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>全景照片查看器</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #fff;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        #password-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        #password-form {
            background-color: rgba(30, 30, 30, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #password-form h2 {
            margin-top: 0;
            color: #fff;
            font-weight: 500;
            margin-bottom: 25px;
        }
        
        #password-input {
            padding: 15px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            outline: none;
        }
        
        #submit-password {
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        #submit-password:hover {
            background-color: #45a049;
        }
        
        #error-message {
            color: #ff6b6b;
            margin-top: 15px;
            height: 20px;
            font-size: 14px;
        }
        
        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #controls {
            position: absolute;
            bottom: 25px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 100;
            padding: 0 20px;
        }
        
        .control-btn {
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            min-width: 80px;
            text-align: center;
        }
        
        .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        #upload-btn {
            position: absolute;
            top: 25px;
            right: 15px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        #upload-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        #upload-container {
            position: absolute;
            top: 85px;
            right: 15px;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            width: 250px;
            transform: translateX(300px);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #upload-container.visible {
            transform: translateX(0);
        }
        
        #upload-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        #file-upload {
            width: 100%;
            margin-bottom: 10px;
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
        
        .custom-upload-btn {
            display: block;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .custom-upload-btn:hover {
            background-color: #45a049;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 50px;
            display: none;
            z-index: 200;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #close-upload {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
            cursor: pointer;
        }
        
        @media (max-width: 480px) {
            .control-btn {
                padding: 10px 15px;
                font-size: 13px;
                min-width: 70px;
            }
            
            #controls {
                bottom: 15px;
                gap: 10px;
            }
            
            #upload-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
                top: 15px;
            }
            
            #upload-container {
                top: 70px;
                right: 10px;
                width: calc(100% - 20px);
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div id="password-screen">
        <div id="password-form">
            <h2>全景照片查看器</h2>
            <input type="password" id="password-input" placeholder="请输入访问密码">
            <button id="submit-password">进入查看器</button>
            <div id="error-message"></div>
        </div>
    </div>

    <div id="container">
        <div id="loading">
            <i class="fas fa-spinner fa-spin"></i> 加载中...
        </div>
        
        <button id="upload-btn" title="上传照片">
            <i class="fas fa-cloud-upload-alt"></i>
        </button>
        
        <div id="upload-container">
            <button id="close-upload"><i class="fas fa-times"></i></button>
            <label id="upload-label">上传全景照片</label>
            <label for="file-upload" class="custom-upload-btn">
                <i class="fas fa-folder-open"></i> 选择文件
            </label>
            <input type="file" id="file-upload" accept="image/jpeg,image/png">
            <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;">
                支持JPEG/PNG格式的全景图片
            </div>
        </div>
        
        <div id="controls">
            <button class="control-btn" id="prev-btn">
                <i class="fas fa-arrow-left"></i> 上一张
            </button>
            <button class="control-btn" id="next-btn">
                下一张 <i class="fas fa-arrow-right"></i>
            </button>
            <button class="control-btn" id="reset-btn">
                <i class="fas fa-sync-alt"></i> 重置
            </button>
        </div>
    </div>

    <script>
        // 密码验证
        const passwordScreen = document.getElementById('password-screen');
        const passwordInput = document.getElementById('password-input');
        const submitPassword = document.getElementById('submit-password');
        const errorMessage = document.getElementById('error-message');
        const container = document.getElementById('container');

        submitPassword.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });

        function checkPassword() {
            if (passwordInput.value === 'cd102') {
                passwordScreen.style.display = 'none';
                container.style.display = 'block';
                initPanoramaViewer();
            } else {
                errorMessage.textContent = '密码错误，请重试';
                passwordInput.focus();
            }
        }

        // 全景查看器
        function initPanoramaViewer() {
            // 预设的三张全景照片
            const presetImages = ['1.jpg', '2.jpg', '3.jpg'];
            
            let currentImageIndex = 0;
            let scene, camera, renderer, controls, sphere, texture;
            const loadingElement = document.getElementById('loading');
            
            // 上传面板控制
            const uploadBtn = document.getElementById('upload-btn');
            const uploadContainer = document.getElementById('upload-container');
            const closeUpload = document.getElementById('close-upload');
            
            uploadBtn.addEventListener('click', () => {
                uploadContainer.classList.toggle('visible');
            });
            
            closeUpload.addEventListener('click', () => {
                uploadContainer.classList.remove('visible');
            });
            
            // 初始化Three.js场景
            function init() {
                // 创建场景
                scene = new THREE.Scene();
                
                // 创建相机
                camera = new THREE.PerspectiveCamera(
                    75, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    1000
                );
                camera.position.z = 0.1;
                
                // 创建渲染器
                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    powerPreference: "high-performance"
                });
                renderer.setPixelRatio(window.devicePixelRatio || 1);
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.insertBefore(renderer.domElement, container.firstChild);
                
                // 添加控制器
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                
                // 缩放
                controls.enableZoom = true;
                controls.zoomSpeed = 1.0;
                
                // 反转鼠标拖拽方向
                controls.mouseButtons = {
                    LEFT: THREE.MOUSE.ROTATE,
                    MIDDLE: THREE.MOUSE.DOLLY,
                    RIGHT: THREE.MOUSE.PAN
                };
                
                // 反转旋转方向
                controls.rotateSpeed = -0.5;
                
                controls.enableDamping = true;
                controls.dampingFactor = 0.1;
                controls.minDistance = 0.1;
                controls.maxDistance = 2;
                controls.screenSpacePanning = false;
                
                // 移动设备双指缩放
                controls.touches = {
                    ONE: THREE.TOUCH.ROTATE,
                    TWO: THREE.TOUCH.DOLLY_PAN
                };
                
                // 加载第一张图片
                loadPanorama(presetImages[currentImageIndex]);
                
                // 窗口大小调整
                window.addEventListener('resize', onWindowResize, false);
                
                // 添加控制按钮事件
                document.getElementById('prev-btn').addEventListener('click', showPreviousImage);
                document.getElementById('next-btn').addEventListener('click', showNextImage);
                document.getElementById('reset-btn').addEventListener('click', resetView);
                document.getElementById('file-upload').addEventListener('change', handleFileUpload);
                
                // 开始动画循环
                animate();
            }
            
            // 加载全景图
            function loadPanorama(imageUrl) {
                loadingElement.style.display = 'flex';
                
                // 移除旧的球体
                if (sphere) {
                    scene.remove(sphere);
                    if (texture) texture.dispose();
                }
                
                // 创建新的纹理加载器
                const loader = new THREE.TextureLoader();
                loader.load(
                    imageUrl,
                    function(newTexture) {
                        texture = newTexture;
                        
                        // 创建球体几何体
                        const geometry = new THREE.SphereGeometry(
                            500, 
                            Math.min(80, Math.floor(window.innerWidth / 10)), 
                            Math.min(40, Math.floor(window.innerHeight / 10))
                        );
                        
                        // 反转几何体使纹理在内部
                        geometry.scale(-1, 1, 1);
                        
                        // 创建材质
                        const material = new THREE.MeshBasicMaterial({
                            map: texture,
                            side: THREE.DoubleSide
                        });
                        
                        // 创建球体网格
                        sphere = new THREE.Mesh(geometry, material);
                        scene.add(sphere);
                        
                        loadingElement.style.display = 'none';
                    },
                    undefined,
                    function(error) {
                        console.error('加载图片出错:', error);
                        loadingElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> 加载失败，请检查图片';
                    }
                );
            }
            
            // 显示上一张图片
            function showPreviousImage() {
                currentImageIndex = (currentImageIndex - 1 + presetImages.length) % presetImages.length;
                loadPanorama(presetImages[currentImageIndex]);
                resetView();
            }
            
            // 显示下一张图片
            function showNextImage() {
                currentImageIndex = (currentImageIndex + 1) % presetImages.length;
                loadPanorama(presetImages[currentImageIndex]);
                resetView();
            }
            
            // 重置视角
            function resetView() {
                controls.reset();
                camera.position.z = 0.1;
                controls.update();
            }
            
            // 处理文件上传
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    alert('请上传有效的图片文件');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadContainer.classList.remove('visible');
                    loadPanorama(e.target.result);
                    resetView();
                };
                reader.readAsDataURL(file);
            }
            
            // 窗口大小调整处理
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            
            // 初始化全景查看器
            init();
        }
    </script>
</body>
</html>